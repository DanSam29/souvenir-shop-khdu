@startuml
|СуперАдмін|
start
:Увійти в адміністративну панель;
:Перейти до розділу "Системні налаштування";
:Вибрати підрозділ "Інтеграції";

|Система|
:Відобразити список доступних інтеграцій:
- Stripe (Платежі)
- Nova Poshta (Доставка);

|СуперАдмін|
:Натиснути на "Stripe (Платежі)";

|Система|
:Відобразити форму налаштування Stripe з полями:
- Publishable Key
- Secret Key (приховане)
- Webhook Secret
- Webhook URL (readonly)
- Режим (Sandbox/Production);
:Автоматично згенерувати та відобразити Webhook URL;

|СуперАдмін|
:Скопіювати Webhook URL;
:Перейти в панель Stripe Dashboard (нова вкладка);

|Stripe Dashboard|
:Відкрити розділ "Webhooks";

|СуперАдмін|
:Натиснути "Add endpoint";
:Вставити Webhook URL;
:Вибрати події webhook:
- payment_intent.succeeded
- payment_intent.payment_failed
- checkout.session.completed;
:Зберегти webhook в Stripe;

|Stripe Dashboard|
:Створити webhook endpoint;
:Згенерувати Webhook Secret;
:Відобразити Webhook Secret;

|СуперАдмін|
:Скопіювати Webhook Secret;
:Повернутися до адмін-панелі;
:Вставити Publishable Key у відповідне поле;
:Вставити Secret Key у відповідне поле;
:Вставити Webhook Secret у відповідне поле;
:Вибрати режим "Sandbox" або "Production";

if (Режим = "Production"?) then (Так)
    |Система|
    :Показати попередження "Увага! Ви перемикаєтеся на Production режим. Використовуйте реальні API ключі";
  
    |СуперАдмін|
    if (Підтвердити?) then (Ні)
        stop
    else (Так)
    endif
else (Ні)
endif

|СуперАдмін|
:Натиснути кнопку "Зберегти налаштування";

|Система (Frontend)|
:Валідувати формат ключів;
if (Publishable Key починається з "pk"?) then (Ні)
    :Показати помилку "Некоректний формат Publishable Key";
    stop
else (Так)
    if (Secret Key починається з "sk"?) then (Ні)
        :Показати помилку "Некоректний формат Secret Key";
        stop
    else (Так)
        if (Webhook Secret починається з "whsec"?) then (Ні)
            :Показати помилку "Некоректний формат Webhook Secret";
            stop
        else (Так)
            :Надіслати запит на Backend API;
        endif
    endif
endif

|Система (Backend)|
:Отримати дані налаштувань;
:Шифрувати Secret Key та Webhook Secret;
:Зберегти ключі в env файлі або секретному сховищі;
:Оновити конфігурацію Stripe SDK;
:Повернути успішну відповідь;

|Система|
:Показати повідомлення "Налаштування збережено";
:Запропонувати протестувати інтеграцію;

|СуперАдмін|
:Натиснути кнопку "Тестувати інтеграцію";

|Система (Backend)|
:Створити тестову платіжну сесію через Stripe API;
if (Stripe API відповів?) then (Ні)
    :Повернути помилку "Не вдалося підключитися до Stripe API";
  
    |Система|
    :Показати повідомлення про помилку;
    :Запропонувати перевірити API ключі;
    :Встановити статус інтеграції "Помилка";
    stop
else (Так)
    if (API ключі валідні?) then (Ні)
        :Повернути помилку "Некоректний Secret Key";
    
        |Система|
        :Показати повідомлення "Перевірте правильність Secret Key";
        :Встановити статус інтеграції "Помилка";
        stop
    else (Так)
        :Перевірити отримання webhook від Stripe (таймаут 30 секунд);
        if (Webhook отримано?) then (Ні)
            :Повернути попередження "Webhook не отримано";
      
            |Система|
            :Показати повідомлення "Webhook налаштовано некоректно";
            :Показати інструкцію з перевірки webhook;
            :Встановити статус інтеграції "Потребує перевірки";
            stop
        else (Так)
            if (Підпис webhook валідний?) then (Ні)
                :Повернути помилку "Невірний Webhook Secret";
        
                |Система|
                :Показати повідомлення "Перевірте правильність Webhook Secret";
                :Встановити статус інтеграції "Помилка";
                stop
            else (Так)
                :Повернути результат "Тест успішний";
        
                |Система|
                :Показати повідомлення "Інтеграція працює коректно";
                :Оновити статус інтеграції на "Активна";
                :Відобразити зелений індикатор біля Stripe в списку інтеграцій;
            endif
        endif
    endif
endif

|СуперАдмін|
:Переглянути статус інтеграції "Активна";

stop
@enduml