@startuml Оформлення_прибуткової_накладної

|Менеджер|
start
:Увійти в адміністративну панель;
:Перейти до розділу "Складський облік";

|Система|
:Відобразити меню:
- Оформити прибуткову накладну
- Переглянути історію надходжень
- Переглянути поточні залишки;

|Менеджер|
:Натиснути "Оформити прибуткову накладну";

|Система|
:Відобразити форму з полями:
- Товар (випадаючий список)
- Кількість
- Закупівельна ціна за одиницю (грн)
- Фірма-постачальник (випадаючий список)
- Дата надходження
- Примітки (опціонально);
note right
Список фірм завантажується з БД.
Можливість додати нову фірму безпосередньо з форми.
end note

|Менеджер|
:Вибрати товар зі списку;

|Система|
:Відобразити поточний залишок обраного товару;

|Менеджер|
:Ввести кількість;
:Ввести закупівельну ціну;
:Обрати фірму-постачальника зі списку;
if (Фірми немає в списку?) then (Так)
    :Натиснути "Додати нову фірму";

    |Система|
    :Відобразити форму створення фірми:
    - Назва фірми
    - Контактна особа
    - Телефон
    - Email
    - Адреса
    - Примітки;

    |Менеджер|
    :Заповнити дані фірми;
    :Зберегти фірму;

    |Система (Backend)|
    :Валідувати дані фірми;
    if (Валідація пройдена?) then (Ні)
        :Показати помилки;
        stop
    else (Так)
        :Створити запис в таблиці Companies;
        :Повернутися до форми накладної;
        :Автоматично обрати нову фірму;
    endif
else (Ні)
endif

|Менеджер|
:Встановити дату надходження (за замовчуванням - поточна);
:Додати примітки (за бажанням);

|Система (Frontend)|
:Валідувати введені дані;

if (Товар вибрано?) then (Ні)
    :Показати помилку "Оберіть товар зі списку";
    :Підсвітити поле червоним;
    stop
else (Так)
endif

if (Кількість > 0?) then (Ні)
    :Показати помилку "Кількість має бути більше 0";
    :Підсвітити поле червоним;
    stop
else (Так)
endif

if (Закупівельна ціна > 0?) then (Ні)
    :Показати помилку "Ціна має бути більше 0";
    :Підсвітити поле червоним;
    stop
else (Так)
endif

if (Фірма-постачальник обрана?) then (Ні)
    :Показати помилку "Вкажіть фірму-постачальника";
    :Підсвітити поле червоним;
    stop
else (Так)
endif

|Менеджер|
:Натиснути "Зберегти накладну";

|Система (Frontend)|
:Відобразити попередній перегляд:
- Товар
- Кількість
- Загальна сума (кількість * ціна)
- Фірма-постачальник
- Дата надходження;

:Запитати підтвердження;

|Менеджер|
if (Підтвердити?) then (Ні)
    :Повернутися до форми;
    stop
else (Так)
    :Натиснути "Підтвердити";
endif

|Система (Frontend)|
:Надіслати запит на Backend API;

|Система (Backend)|
:Отримати дані накладної;
:Перевірити права доступу Менеджера;

if (Права достатні?) then (Ні)
    :Повернути помилку 403 Forbidden;
  
    |Система|
    :Показати повідомлення "Недостатньо прав";
    stop
else (Так)
endif

:Перевірити, чи існує товар в БД;

if (Товар існує?) then (Ні)
    :Повернути помилку "Товар не знайдено";
  
    |Система|
    :Показати помилку;
    stop
else (Так)
endif

:Розпочати транзакцію БД;

fork
    :Створити запис в таблиці IncomingDocuments:
    - ProductId
    - Quantity
    - PurchasePrice
    - CompanyId
    - DocumentDate
    - CreatedAt
    - CreatedBy (Менеджер)
    - Notes;
fork again
    :Оновити поле Products.Stock:
    Stock = Stock + Quantity;
fork again
    :Додати запис в audit log для аудиту;
end fork

:Зафіксувати транзакцію;

if (Транзакція успішна?) then (Ні)
    :Відкотити зміни;
    :Логувати помилку в Serilog;
    :Повернути помилку "Не вдалося зберегти накладну";
  
    |Система|
    :Показати повідомлення про помилку;
    stop
else (Так)
    :Логувати успішне створення накладної в Serilog;
    :Повернути успішну відповідь з новим залишком;
endif

|Система|
:Показати повідомлення "Прибуткова накладна успішно оформлена";
:Відобразити:
- Номер накладної
- Попередній залишок
- Надійшло
- Новий залишок товару;

|Менеджер|
:Переглянути оновлену інформацію;
stop

@enduml