@startuml Додавання_нового_товару

|Менеджер|
start
:Увійти в адміністративну панель;
:Перейти до розділу "Керування товарами";
:Натиснути кнопку "Додати товар";

|Система|
:Відобразити форму додавання товару з полями:
- Назва
- Опис
- Ціна (грн)
- Вага (кг)
- Категорія
- Зображення;

|Менеджер|
:Ввести назву товару;
:Ввести опис товару;
:Ввести ціну (грн);
:Ввести вагу (кг);
:Вибрати категорію з випадаючого списку;
:Завантажити зображення;

|Система|
:Валідувати формат зображень;
if (Формат JPEG/PNG/WebP?) then (Ні)
    :Показати помилку "Невірний формат файлу. Підтримуються: JPEG, PNG, WebP";
    stop
else (Так)
    :Валідувати розмір файлів;
    if (Розмір зображення <= 5 MB?) then (Ні)
        :Показати помилку "Файл занадто великий. Максимум: 5 МБ";
        stop
    else (Так)
        :Відобразити попередній перегляд зображень;
    endif
endif

|Менеджер|
:Встановити головне зображення (перше за замовчуванням);
:Натиснути "Зберегти товар";

|Система (Frontend)|
:Валідувати всі обов'язкові поля;
if (Всі поля заповнені?) then (Ні)
    :Показати помилку "Заповніть всі обов'язкові поля";
    :Підсвітити порожні поля червоним;
    stop
else (Так)
    if (Ціна > 0?) then (Ні)
        :Показати помилку "Ціна має бути більше 0";
        :Підсвітити поле ціни червоним;
        stop
    else (Так)
        if (Вага > 0?) then (Ні)
            :Показати помилку "Вага має бути більше 0";
            :Підсвітити поле ваги червоним;
            stop
        else (Так)
            if (Зображення завантажено?) then (Ні)
                :Показати помилку "Необхідно завантажити хоча б одне зображення";
                :Підсвітити поле зображення червоним;
                stop
            else (Так)
                :Надіслати запит на Backend API з даними форми;
            endif
        endif
    endif
endif

|Система (Backend)|
:Отримати дані товару;
:Перевірити, чи назва товару вже існує в категорії;
if (Назва існує?) then (Так)
    :Показати попередження "Товар з такою назвою вже існує в цій категорії";
    :Запропонувати продовжити або змінити;
  
    |Менеджер|
    if (Продовжити?) then (Ні)
        stop
    else (Так)
    endif
endif

|Система (Backend)|
:Завантажити зображення в MinIO;
if (MinIO доступний?) then (Ні)
    :Повернути помилку "Помилка завантаження зображення";
    :Логувати помилку в Serilog;
    stop
else (Так)
    :Згенерувати унікальні імена файлів (UUID + extensions);
    :Отримати URL зображень з MinIO;
endif

fork
    :Створити запис в таблиці Products:
    - Name
    - Description
    - Price
    - Weight
    - CategoryId
    - CreatedAt;
  
note right: Stock не створюється,\nкількість буде 0 до першої прибуткової накладної

fork again
    :Зберегти посилання на зображення в таблиці ProductImages:
    - ProductId
    - ImageURL
    - IsPrimary
    - Order;

fork again
    :Менеджер може встановити базову знижку для товару (опціонально);
    if (Встановити знижку?) then (Так)
        :Система відображає форму створення знижки;
        :Менеджер вибирає тип знижки (%, фіксована, спеціальна ціна);
        :Менеджер вводить значення знижки;
        :Менеджер встановлює дати дії (опціонально);
        :Система створює Promotion для цього товару;
    else (Ні)
    endif
end fork

:Логувати створення товару в Serilog;

|Система (Frontend)|
:Показати повідомлення "Товар успішно додано";
:Запропонувати:
1. Оформити прибуткову накладну для надходження товару на склад
2. Створити акцію/знижку для цього товару;

|Менеджер|
if (Що обрати?) then (Оформити надходження)
    :Перенаправити на форму прибуткової накладної;
    note right
        При оформленні прибуткової накладної
        менеджер обирає фірму-постачальника
        зі списку (замість введення назви вручну)
    end note
    stop
else if (Створити акцію)
    :Перенаправити на форму створення акції;
    note right
        Товар вже буде обраний автоматично
        в полі "Застосувати до товару"
    end note
    stop
else (Ні, перейти до списку)
    :Перенаправити на список товарів;
    stop
endif

@enduml