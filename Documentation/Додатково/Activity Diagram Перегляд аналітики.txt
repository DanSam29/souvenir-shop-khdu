@startuml Перегляд_аналітики

|Менеджер/Адміністратор|
start
:Увійти в адміністративну панель;
:Перейти до розділу "Аналітика";

|Система|
:Відобразити меню аналітики:
- Аналітика продажів
- Популярність товарів
- Аналітика категорій
- Ефективність акцій;

|Менеджер/Адміністратор|
:Натиснути "Аналітика продажів";

|Система|
:Відобразити форму фільтрів:
- Період (дати з/по або preset: сьогодні, тиждень, місяць, квартал, рік)
- Групування (день/тиждень/місяць)
- Товар (опціонально)
- Категорія (опціонально)
- Спосіб оплати (опціонально)
- Статус замовлення (опціонально);

note right
За замовчуванням:
- Період: останні 30 днів
- Групування: по днях
- Без фільтрів за товаром/категорією
end note

|Менеджер/Адміністратор|
:Вибрати період;

if (Використовувати preset?) then (Так)
    :Вибрати preset (сьогодні/тиждень/місяць);
    
    |Система|
    :Автоматично встановити дати початку та кінця;
else (Ні)
    :Вручну вказати дати з/по;
    
    |Система|
    :Валідувати введені дати;
    
    if (Дата початку <= Дата кінця?) then (Ні)
        :Показати помилку "Дата початку має бути меншою за дату кінця";
        stop
    else (Так)
        if (Період <= 2 роки?) then (Ні)
            :Показати попередження "Занадто великий період. Рекомендовано до 2 років";
        else (Так)
        endif
    endif
endif

|Менеджер/Адміністратор|
:Вибрати групування (день/тиждень/місяць);

if (Застосувати фільтри?) then (Так)
    :Вибрати фільтри (товар/категорія/спосіб оплати/статус);
else (Ні)
endif

:Натиснути "Показати звіт";

|Система (Frontend)|
:Відобразити індикатор завантаження;
:Надіслати запит на Backend API;

|Система (Backend - AnalyticsController)|
:Отримати параметри запиту (period, groupBy, filters);
:Валідувати параметри;

if (Параметри валідні?) then (Ні)
    :Повернути помилку 400 Bad Request;
    
    |Система|
    :Показати повідомлення про помилку;
    stop
else (Так)
endif

:Передати запит в AnalyticsService;

|Система (Backend - AnalyticsService)|
:Сформувати ключ кешу на основі параметрів;
:Перевірити наявність даних у кеші;

if (Дані в кеші?) then (Так)
    if (Кеш актуальний?) then (Так)
        :Отримати дані з кешу;
        note right
            Кеш вважається актуальним, якщо:
            - Не минуло 15 хвилин від розрахунку
            - Не було нових замовлень після розрахунку
        end note
    else (Ні)
        :Інвалідувати застарілий кеш;
    endif
else (Ні)
endif

if (Потрібно розраховувати?) then (Так)
    :Запитати дані з OrderRepository, ProductRepository;
    
    partition "Розрахунок метрик" {
        fork
            :Розрахувати загальну кількість замовлень за період;
        fork again
            :Розрахувати загальний дохід (sum of Order.totalAmount + Order.shippingCost);
        fork again
            :Розрахувати середній чек (totalRevenue / totalOrders);
        fork again
            :Згрупувати продажі за обраний період (день/тиждень/місяць);
        fork again
            :Розрахувати розподіл за способами оплати;
        fork again
            :Розрахувати розподіл за статусами замовлень;
        fork again
            :Визначити топ-10 товарів за доходом в обраному періоді;
        end fork
        
        :Сформувати об'єкт SalesAnalyticsDTO;
    }
    
    :Зберегти результат у кеш (TTL = 15 хвилин);
    :Логувати запит аналітики в Serilog;
else (Ні використовуємо кеш)
endif

:Повернути SalesAnalyticsDTO в AnalyticsController;

|Система (Backend - AnalyticsController)|
:Повернути HTTP 200 OK з даними;

|Система (Frontend)|
:Отримати дані аналітики;
:Приховати індикатор завантаження;

partition "Візуалізація даних" {
    :Відобразити KPI картки:
    - Загальна кількість замовлень
    - Загальний дохід
    - Середній чек
    - Зміна відносно попереднього періоду (%);
    
    :Побудувати графік динаміки продажів:
    - Вісь X: період (дні/тижні/місяці)
    - Вісь Y: дохід
    - Line chart з точками;
    
    :Побудувати pie chart розподілу за способами оплати:
    - Card Online
    - Cash on Delivery;
    
    :Побудувати bar chart розподілу за статусами:
    - Pending Payment
    - Processing
    - Shipped
    - Delivered
    - Cancelled;
    
    :Відобразити таблицю топ-10 товарів:
    - Назва товару
    - Кількість продажів
    - Дохід
    - Частка у загальному доході (%);
}

note right
    Всі графіки інтерактивні:
    - Можна навести на точку для деталей
    - Можна приховати/показати серії
    - Є можливість zoom
end note

|Менеджер/Адміністратор|
:Переглянути звіт;

if (Змінити параметри?) then (Так)
    :Змінити період або фільтри;
    :Натиснути "Оновити звіт";
    
    |Система|
    :Повторити процес з новими параметрами;
else (Ні)
endif

if (Експортувати звіт?) then (Так)
    :Натиснути "Експортувати";
    :Вибрати формат (PDF/CSV/Excel);
    
    |Система (Frontend)|
    :Надіслати запит на експорт;
    
    |Система (Backend - AnalyticsService)|
    :Отримати дані аналітики;
    
    if (Формат?) then (PDF)
        :Згенерувати PDF з графіками та таблицями;
        :Повернути файл для завантаження;
    else if (CSV) then
        :Згенерувати CSV з табличними даними;
        :Повернути файл для завантаження;
    else (Excel)
        :Згенерувати XLSX з декількома листами:
        - Лист 1: Загальні метрики
        - Лист 2: Динаміка продажів
        - Лист 3: Топ товарів;
        :Повернути файл для завантаження;
    endif
    
    |Система (Frontend)|
    :Завантажити файл на пристрій користувача;
    
    |Менеджер/Адміністратор|
    :Отримати експортований звіт;
else (Ні)
endif

:Завершити роботу зі звітом;
stop

@enduml