@startuml
|Адміністратор|
start
:Увійти в адміністративну панель;
:Перейти до розділу "Керування замовленнями";

|Система|
:Відобразити список всіх замовлень з фільтрами;

|Адміністратор|
:Вибрати замовлення зі списку;

|Система|
:Завантажити дані замовлення з БД;
:Відобразити детальну інформацію:
- Номер замовлення
- Дата створення
- Користувач (ім'я, email, телефон)
- Список товарів
- Загальна сума
- Спосіб доставки та адреса
- Поточний статус
- Історія змін статусів;

|Адміністратор|
:Натиснути кнопку "Змінити статус";

|Система|
:Відобразити випадаючий список доступних статусів:
- Обробляється
- Відправлено
- Доставлено
- Скасовано;

|Адміністратор|
:Вибрати новий статус;

|Система|
:Перевірити, чи дозволений перехід від старого статусу до нового;
if (Перехід дозволений?) then (Ні)
    :Показати помилку "Неможливо змінити статус з [старий] на [новий]";
    :Показати список дозволених переходів;
    stop
else (Так)
    if (Новий статус = "Скасовано"?) then (Так)
        :Показати попередження "Ви впевнені? Товари будуть повернені на склад";
        :Відобразити поле "Причина скасування";
    
        |Адміністратор|
        :Ввести причину скасування;
        if (Підтвердити?) then (Ні)
            :Скасувати операцію;
            stop
        else (Так)
        endif
    else (Ні)
    endif
endif

|Система|
:Відобразити поле для коментаря (опціонально);

|Адміністратор|
:Ввести коментар (наприклад, ТТН);
:Натиснути кнопку "Підтвердити";

|Система (Backend)|
:Отримати запит на зміну статусу;
:Перевірити права доступу Адміністратора;
if (Права достатні?) then (Ні)
    :Повернути помилку 403 Forbidden;
  
    |Система|
    :Показати повідомлення "Недостатньо прав";
    stop
else (Так)
    :Перевірити, чи замовлення існує в БД;
    if (Замовлення існує?) then (Ні)
        :Повернути помилку "Замовлення не знайдено";
        stop
    else (Так)
        :Перевірити поточний статус замовлення;
        if (Статус змінився?) then (Ні)
            :Повернути повідомлення "Замовлення вже має цей статус";
      
            |Система|
            :Показати інформаційне повідомлення;
            stop
        else (Так)
            if (Статус = "Скасовано"?) then (Так)
                fork
                    :Оновити статус на "Скасовано";
                fork again
                    :Повернути товари на склад (збільшити Stock);
                fork again
                    :Створити запис в таблиці OrderCancellations з причиною;
                fork again
                    :Додати запис в таблицю OrderHistory;
                end fork
        
                :Підготувати Email з причиною скасування;
            else (Ні)
                :Оновити поле Status в таблиці Orders;
                :Додати запис в таблицю OrderHistory:
                - OldStatus
                - NewStatus
                - ChangedBy
                - Comment
                - Timestamp;

                :Підготувати Email про зміну статусу;
            endif
      
            :Надіслати Email користувачу через Email Service;
            if (Email відправлено?) then (Ні)
                :Логувати помилку в Serilog;
                :Створити задачу для повторної відправки;
            else (Так)
            endif
      
            :Логувати зміну статусу в Serilog;
            :Повернути успішну відповідь;
        endif
    endif
endif

|Система|
:Показати повідомлення "Статус замовлення успішно змінено";
:Оновити інформацію про замовлення на сторінці;
:Відобразити новий статус в списку замовлень;

|Адміністратор|
:Переглянути оновлену інформацію;

stop
@enduml