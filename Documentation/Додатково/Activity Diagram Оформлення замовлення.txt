@startuml Оформлення_замовлення

|Користувач|
start
:Перейти до кошика;

|Система|
:Відобразити список товарів та загальну суму;
:Перевірити доступні знижки для користувача:
- Студентські знижки (якщо studentStatus активний)
- Персональні знижки (UserPromotions)
- Акційні знижки (активні Promotions);
:Попередньо розрахувати суму з урахуванням автоматичних знижок;
:Відобразити деталізацію:
- Сума товарів
- Автоматичні знижки
- Проміжна сума;

|Користувач|
:Натиснути "Оформити замовлення";

|Система|
:Перевірити наявність товарів на складі;

if (Всі товари доступні?) then (Ні)
    :Показати повідомлення "Товар недоступний";
    :Запропонувати видалити товар з кошика;
    stop
else (Так)
    :Перевірити мінімальну суму замовлення (100 грн);
  
    if (Сума >= 100 грн?) then (Ні)
        :Показати повідомлення "Мінімальна сума замовлення - 100 грн";
        stop
    else (Так)
        :Відобразити форму оформлення замовлення;
    endif
endif

|Користувач|
:Перевірити/редагувати контактні дані;
:Вибрати спосіб доставки "Nova Poshta";

|Система|
:Надіслати запит до Nova Poshta API (список населених пунктів);

if (Nova Poshta API доступний?) then (Ні)
    :Показати повідомлення "Сервіс доставки тимчасово недоступний";
    stop
else (Так)
    :Відобразити список населених пунктів з пошуком;
endif

|Користувач|
:Вибрати населений пункт;

|Система|
:Надіслати запит до Nova Poshta API (список відділень у населеному пункті);
:Відобразити список відділень Nova Poshta;

|Користувач|
:Вибрати відділення Nova Poshta;

|Система|
:Надіслати запит Nova Poshta API (розрахунок вартості доставки);
:Отримати вартість доставки з API;
:Розрахувати загальну суму (товари + доставка);
:Відобразити загальну суму з деталізацією:
- Вартість товарів (без знижок)
- Застосовані знижки
- Проміжна сума товарів
- Вартість доставки
- Підсумок до оплати;
:Відобразити поле для введення промокоду (опціонально);
:Відобразити вибір способу оплати:
- Карткою онлайн
- Оплата при отриманні;

|Користувач|
if (Бажає ввести промокод?) then (Так)
    :Ввести промокод;
  
    |Система (Backend - PromotionService)|
    :Отримати промокод від користувача;
    :Перевірити існування промокоду в БД;
  
    if (Промокод існує?) then (Ні)
        :Показати повідомлення "Промокод не знайдено";
    else (Так)
        :Перевірити валідність промокоду:
        - Чи активний (isActive = true)
        - Чи в межах дат дії (startDate <= now <= endDate)
        - Чи не вичерпано ліміт (currentUsage < usageLimit);
    
        if (Промокод валідний?) then (Ні)
            if (Закінчився термін дії?) then (Так)
                :Показати "Промокод недійсний (закінчився термін дії)";
            else if (Вичерпано ліміт?) then (Так)
                :Показати "Промокод вичерпано";
        else (Деактивований)
            :Показати "Промокод недійсний";
        endif
    else (Так)
            :Перевірити чи промокод вже застосований до цього замовлення;
      
            if (Промокод вже застосований?) then (Так)
                :Показати "Промокод вже застосовано";
            else (Ні)
                :Застосувати промокод до замовлення;
                :Розрахувати додаткову знижку від промокоду;
        
                note right
                    Промокод застосовується ДО автоматичних знижок.
                    Стакування знижок:
                    1. Автоматичні знижки (студентські, персональні, акційні)
                    2. Промокод (якщо введено)
          
                    Пріоритет за максимальною вигодою для користувача
                end note
        
                :Перерахувати загальну суму з урахуванням промокоду;
                :Відобразити оновлену деталізацію з промокодом;
                :Показати "Промокод успішно застосовано!";
            endif
        endif
    endif
else (Ні)
endif

|Користувач|
:Вибрати спосіб оплати;

if (Спосіб оплати?) then (Карткою онлайн)
    |Користувач|
    :Натиснути "Підтвердити замовлення";
  
    |Система (Backend - OrderService)|
    :Отримати дані замовлення з Frontend;

    :PromotionService → розрахувати фінальні ціни для кожного товару:
    - originalPrice (базова ціна товару)
    - appliedPromotionId (ID найвигіднішої знижки або промокоду)
    - discountAmount (сума знижки в грн)
    - finalPrice (ціна після знижки);

    note right
        Для кожного товару зберігаємо:
        - originalPrice: Products.price
        - appliedPromotionId: ID з Promotions (найвигідніша знижка)
        - discountAmount: originalPrice - finalPrice
        - finalPrice: ціна після застосування знижки
  
        Якщо стакування:
        - appliedPromotionId = ID промокоду (вищий пріоритет)
        - discountAmount = сума всіх знижок
    end note

    fork
        :Створити запис замовлення в БД (status: "Очікує оплати");
    fork again
        :Створити OrderItems з повною інформацією про знижки:
        - productId, quantity
        - originalPrice
        - appliedPromotionId
        - discountAmount
        - finalPrice;
    fork again
        :Створити видаткові накладні через WarehouseService (автоматично зменшує Stock);
  
        note right
            WarehouseService отримує дані про знижки
            з OrderItems і зберігає їх в OutgoingDocuments
          end note
    end fork
  
    note right: Видаткова накладна створюється\nавтоматично для кожного товару\nв замовленні з Reason="Order"
  
    :Генерувати сесію оплати в Stripe через API;
  
    if (Stripe API доступний?) then (Ні)
        :Показати повідомлення "Помилка платіжної системи";
        :Відкотити транзакцію БД:
        - Видалити Order
        - Видалити OutgoingDocuments
        - Повернути Stock;
        stop
    else (Так)
        :Перенаправити користувача на сторінку Stripe;
    endif
  
    |Користувач|
    :Ввести дані банківської картки;
  
    |Stripe|
    :Обробити платіж;
  
    if (Платіж успішний?) then (Ні)
        :Повернути статус "Відхилено" через webhook;
    
        |Система (Backend)|
        :Оновити статус платежу "Відхилено";
        :Оновити статус замовлення "Скасовано";
        :Видалити видаткові накладні (повернути Stock);
    
        |Система|
        :Показати повідомлення "Оплата відхилена";
        stop
    
    else (Так)
        |Stripe|
        :Повернути статус "Успішно" через webhook;
    endif
  
    |Система (Backend)|
    :Отримати webhook від Stripe;
    :Перевірити підпис webhook (webhook signature);
  
    if (Підпис валідний?) then (Ні)
        :Логувати помилку в Serilog;
        :Ігнорувати webhook;
        stop
    else (Так)
        fork
            :Оновити статус замовлення на "Обробляється";
        fork again
            :Оновити статус платежу на "Оплачено";
        fork again
            :Додати запис у таблицю Payments;
        fork again
            :Додати запис у таблицю OrderHistory;
        end fork
    
        :Надіслати Email-підтвердження користувачу з деталізацією:
        - Номер замовлення
        - Список товарів
        - Вартість товарів (без знижок)
        - Застосовані знижки (деталізація по кожній)
        - Вартість доставки
        - Підсумок оплачено;
    
        if (Email відправлено?) then (Ні)
            :Логувати помилку в Serilog;
            :Створити задачу для повторної відправки;
        else (Так)
        endif
    
    :Очистити кошик користувача;
    
    |Система|
    :Перенаправити на сторінку "Замовлення успішно створено";
    :Відобразити номер та деталі замовлення;
    
    |Користувач|
    :Переглянути деталі замовлення;
    stop
endif

else (Оплата при отриманні)
    |Користувач|
    :Натиснути "Підтвердити замовлення";
  
    |Система (Backend - OrderService)|
    :Отримати дані замовлення з Frontend;

    :PromotionService → розрахувати фінальні ціни для кожного товару:
    - originalPrice
    - appliedPromotionId
    - discountAmount
    - finalPrice;

    fork
        :Створити запис замовлення в БД (status: "Очікує оплати при отриманні");
    fork again
        :Створити OrderItems з повною інформацією про знижки:
        - productId, quantity
        - originalPrice
        - appliedPromotionId
        - discountAmount
        - finalPrice;
    fork again
        :Створити видаткові накладні через WarehouseService (автоматично зменшує Stock);
    fork again
        :Створити запис в таблиці Payments (status: "Очікує оплати при отриманні", method: "Cash on Delivery");
    fork again
        :Додати запис у таблицю OrderHistory;
    fork again
        :Якщо використано промокод → оновити Promotions.currentUsage++;
        :Додати запис в UserPromotions (якщо персональна знижка);
    end fork
  
    note right: Видаткова накладна створюється\nавтоматично при підтвердженні замовлення
  
    :Логувати створення замовлення в Serilog;
  
    :Надіслати Email-підтвердження користувачу з деталями:
    - Номер замовлення
    - Список товарів з цінами
    - Вартість товарів (без знижок)
    - Застосовані знижки (деталізація по кожній)
    - Вартість доставки
    - Сума до сплати при отриманні
    - Адреса відділення Nova Poshta
    - Інструкції з оплати;
  
    if (Email відправлено?) then (Ні)
        :Логувати помилку в Serilog;
        :Створити задачу для повторної відправки;
    else (Так)
    endif
  
    :Очистити кошик користувача;
  
    |Система|
    :Перенаправити на сторінку "Замовлення успішно створено";
    :Відобразити номер та деталі замовлення;
    :Показати повідомлення "Оплатіть замовлення при отриманні на відділенні Nova Poshta";
  
    |Користувач|
    :Переглянути деталі замовлення;
    stop
endif

@enduml	