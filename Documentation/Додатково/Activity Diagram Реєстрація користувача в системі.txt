@startuml Реєстрація_користувача

|Гість|
start
:Перейти на сайт інтернет-магазину;
:Натиснути кнопку "Реєстрація";

|Система (Frontend)|
:Відобразити форму реєстрації з полями:
- Ім'я
- Прізвище
- Email
- Пароль
- Підтвердження паролю
- Телефон (опціонально)
- Згода з умовами використання;

|Гість|
:Заповнити поля;
:Встановити прапорець "Згоден з умовами використання";
:Натиснути кнопку "Зареєструватись";

|Система (Frontend)|
:Валідувати введені дані;

if (Email валідний?) then (Ні)
   :Показати помилку "Email некоректний";
    :Підсвітити поле Email червоним;
    stop
else (Так)
endif

if (Пароль >= 8 символів?) then (Ні)
    :Показати помилку "Пароль має містити мінімум 8 символів";
    :Підсвітити поле паролю червоним;
    stop
else (Так)
endif

if (Пароль містить букви та цифри?) then (Ні)
    :Показати помилку "Пароль має містити букви та цифри";
    :Підсвітити поле паролю червоним;
    stop
else (Так)
endif

if (Паролі співпадають?) then (Ні)
    :Показати помилку "Паролі не співпадають";
    :Підсвітити поля паролей червоним;
    stop
else (Так)
endif

if (Згода на умови використання встановлена?) then (Ні)
    :Показати помилку "Необхідно прийняти умови використання";
    :Підсвітити checkbox згоди червоним;
    stop
else (Так)
endif

:Надіслати запит на Backend API;

|Система (Backend)|
:Отримати дані реєстрації;
:Перевірити унікальність Email в БД;

if (Email вже існує?) then (Так)
    :Повернути помилку "Email вже використовується";
  
    |Система (Frontend)|
    :Показати повідомлення "Цей Email вже зареєстрований.";
    :Запропонувати перейти до форми авторизації;
    stop
else (Ні)
    |Система (Backend)|
    :Хешувати пароль за допомогою bcrypt;
    :Створити новий запис в таблиці Users:
    - FirstName
    - LastName
    - Email
    - PasswordHash
    - Phone
    -CreatedAt;
    :Призначити роль "Користувач";
    :Створити порожній особистий кабінет;
    :Перевірити чи email належить до домену університету (@ksu.edu.ua);

    if (Email університетський?) then (Так)
        :Відправити запит до University API для верифікації студента;
        :University API → GET /students/{email};
  
        if (University API доступний?) then (Так)
            if (Студент знайдений?) then (Так)
                :Отримати дані: studentStatus, GPA, scholarshipStatus;
                :Оновити User:
                - studentStatus
                - gpa
                - studentVerifiedAt = now()
                - studentExpiresAt = now() + 1 семестр (4 місяці);
      
                :Система автоматично призначає студентські знижки;
                note right
                    Залежно від studentStatus:
                    - REGULAR: базова студентська знижка
                    - SCHOLARSHIP: підвищена знижка
                    - HIGH_ACHIEVER (GPA ≥ 4.5): максимальна знижка
                end note
      
                :Додати інформацію про знижки в Email-підтвердження;
            else (Ні)
                :Логувати: Email університетський, але студент не знайдений;
                :Встановити studentStatus = NONE;
            endif
        else (Ні)
            :Логувати помилку: University API недоступний;
            :Створити задачу для повторної перевірки через 1 годину;
            :Встановити studentStatus = NONE (тимчасово);
        endif
    else (Ні)
        :Встановити studentStatus = NONE;
    endif
    :Генерувати JWT токен для автоматичної авторизації;
    :Підготувати Email з підтвердженням реєстрації;
    :Надіслати Email через Email Service;
  
    if (Email відправлено?) then (Ні)
        :Логувати помилку в Serilog;
        :Створити задачу для повторної відправки;
    else (Так)
    endif
  
    :Логувати успішну реєстрацію в Serilog;
    :Повернути відповідь з JWT токеном;
endif

|Система (Frontend)|
:Отримати JWT токен;
:Зберегти JWT токен в пам'яті;
:Перенаправити користувача на головну сторінку;
:Показати повідомлення "Реєстрація успішна! Перевірте Email для підтвердження";

|Користувач|
:Переглянути головну сторінку як авторизований користувач;
stop

@enduml